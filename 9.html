<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Forvia Bank Scan Mobil Ver5.3</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- EREDETI STÍLUSOK (V4.7) --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
    --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --accent: #3b82f6;
    --accent-glow: rgba(59, 130, 246, 0.5);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --ok-color: #10b981;
    --err-color: #ef4444;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-gradient); color: var(--text-main);
    margin: 0; padding: 0; width: 100%; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
}
.header {
    flex-shrink: 0; width: 100%; background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
    padding: 15px 20px; text-align: center; z-index: 100;
    padding-top: max(15px, env(safe-area-inset-top)); 
}
.header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: white; }
.header .credits { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; font-weight: 500; }
.header .credits span { color: var(--accent); }

.main-content {
    flex: 1; display: flex; flex-direction: column; padding: 20px;
    overflow-y: auto; align-items: center; width: 100%; -webkit-overflow-scrolling: touch;
}

#reader {
    width: 100%; max-width: 300px; aspect-ratio: 1 / 1; border-radius: 20px;
    overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border: 3px solid var(--accent); display: none; background: black; flex-shrink: 0;
}
#reader video { width: 100% !important; height: 100% !important; object-fit: cover; }

.input-wrapper { width: 100%; max-width: 500px; display: flex; gap: 12px; margin-bottom: 25px; flex-shrink: 0; }
input[type=text] {
    flex: 1; background: var(--glass); border: 1px solid var(--glass-border);
    padding: 16px 20px; border-radius: 16px; color: white; font-size: 1.2rem;
    font-weight: 600; text-align: center; outline: none; backdrop-filter: blur(5px); min-width: 0;
}
.scan-btn {
    width: 60px; height: 60px; border-radius: 16px; border: none;
    background: var(--accent); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px var(--accent-glow); flex-shrink: 0; transition: all 0.2s;
}
.scan-btn.active { background: var(--err-color); }

/* --- ÚJ: PRO GRID MEGJELENÍTÉS (CSAK EZ VÁLTOZOTT) --- */
#resultsWrapper { width: 100%; max-width: 500px; padding-bottom: 20px; }
.result-card {
    background: #1e293b; border-radius: 20px; border: 1px solid var(--glass-border);
    overflow: hidden; animation: popIn 0.3s ease-out; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--glass-border); }
.res-item { background: #1e293b; padding: 15px; text-align: center; }
.res-full { grid-column: span 2; border-bottom: 1px solid var(--glass-border); }
.res-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
.res-value { font-size: 1.3rem; font-weight: 800; color: white; word-break: break-all; }
.res-value.highlight { color: #fbbf24; }

/* --- ELŐZMÉNYEK VISSZAÁLLÍTVA --- */
.footer-history {
    background: rgba(15, 23, 42, 0.95); border-top: 1px solid var(--glass-border);
    height: 150px; flex-shrink: 0; overflow-y: auto; padding: 15px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
}
.history-title { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; font-weight: bold; }
.h-item {
    display: flex; align-items: center; padding: 10px 15px; margin-bottom: 8px;
    background: rgba(255,255,255,0.03); border-radius: 10px; font-size: 0.85rem;
}
.h-time { color: var(--text-muted); margin-right: 15px; font-weight: bold; }
</style>
</head>
<body>

<div class="header">
    <h1>Forvia Cikkszám Scan</h1>
    <div class="credits">Készítette: <span>Gergő Roland</span></div>
</div>

<div class="main-content">
    <div id="loadMsg" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Adatbázis betöltése...</div>
    <div id="reader"></div>
    <div class="input-wrapper">
        <input type="text" id="barcodeInput" placeholder="Scan Barcode" autocomplete="off">
        <button class="scan-btn" onclick="handleCameraButton()">
            <svg id="camIcon" viewBox="0 0 24 24" width="28" fill="white"><path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2zM2 4v16h20V4H2zm18 14H4V6h16v12z"/></svg>
            <svg id="stopIcon" viewBox="0 0 24 24" width="28" fill="white" style="display:none;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
    </div>
    <div id="resultsWrapper"></div>
</div>

<div class="footer-history">
    <div class="history-title">
        <span>Előzmények</span>
        <span onclick="clearHistory()" style="cursor:pointer; color:var(--accent);">Törlés</span>
    </div>
    <div id="historyList"></div>
</div>

<audio id="sndOk" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>
<audio id="sndError" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/* ========================================================
   EREDETI LOGIKA (V4.7) - ÉRINTETLENÜL
   ======================================================== */
const input = document.getElementById('barcodeInput');
const resultsWrapper = document.getElementById('resultsWrapper');
const historyList = document.getElementById('historyList');
const loadMsg = document.getElementById('loadMsg');
const camIcon = document.getElementById('camIcon');
const stopIcon = document.getElementById('stopIcon');
const scanBtn = document.querySelector('.scan-btn');
const readerDiv = document.getElementById('reader');

let html5QrCode = null;
let isCameraRunning = false;
let bankDB = [];

async function init() {
    await loadBankCSV();
    renderHistory();
}

async function loadBankCSV() {
    try {
        const res = await fetch('bank.csv');
        const data = await res.text();
        const lines = data.split('\n');
        const headers = lines[0].split(';');
        let modelIdx = headers.findIndex(h => h.trim().toLowerCase().includes('model'));

        lines.slice(1).forEach(line => {
            const cols = line.split(';');
            if (cols.length < 2) return;
            bankDB.push({
                gep: cols[0]?.trim() || "N/A",
                poz: cols[1]?.trim() || "N/A",
                id: cols[2]?.trim().toUpperCase() || "",
                msd: cols[4]?.trim() || "N/A",
                model: (modelIdx !== -1 && cols[modelIdx]) ? cols[modelIdx].trim() : "BANK"
            });
        });
        loadMsg.innerText = `Adatbázis kész: ${bankDB.length} tétel`;
    } catch (e) { loadMsg.innerText = "HIBA: bank.csv!"; }
}

input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const code = input.value.trim().toUpperCase();
        if (code) search(code);
        input.value = '';
        input.blur();
    }
});

function search(code) {
    resultsWrapper.innerHTML = '';
    const matches = bankDB.filter(i => (code.includes(i.id) || i.id.includes(code)) && i.id.length > 2);

    if (matches.length > 0) {
        playSound(true);
        matches.forEach(m => {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div class="res-grid">
                    <div class="res-item res-full"><div class="res-label">Modelnév</div><div class="res-value">${m.model}</div></div>
                    <div class="res-item"><div class="res-label">Gép azonosító</div><div class="res-value">${m.gep}</div></div>
                    <div class="res-item"><div class="res-label">Pozíció</div><div class="res-value highlight">#${m.poz}</div></div>
                    <div class="res-item"><div class="res-label">Azonosító (ID)</div><div class="res-value" style="font-size:0.9rem;">${m.id}</div></div>
                    <div class="res-item"><div class="res-label">MSD</div><div class="res-value" style="color:#10b981;">${m.msd}</div></div>
                </div>`;
            resultsWrapper.appendChild(card);
        });
        saveToHistory(code);
    } else {
        playSound(false);
        resultsWrapper.innerHTML = '<div style="color:var(--err-color); font-weight:bold; text-align:center; margin-top:20px;">NINCS A LISTÁBAN</div>';
    }
}

function saveToHistory(code) {
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    if (!history.some(h => h.code === code)) {
        history.unshift({ code, time });
        if(history.length > 30) history.pop();
        localStorage.setItem('scanHistory', JSON.stringify(history));
        renderHistory();
    }
}

function renderHistory() {
    const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    historyList.innerHTML = history.map(item => `
        <div class="h-item">
            <span class="h-time">${item.time}</span>
            <span><b>${item.code}</b></span>
        </div>`).join('');
}

function clearHistory() {
    localStorage.removeItem('scanHistory');
    renderHistory();
}

/* --- KAMERA KEZELÉS (EREDETI V4.7 ALAPJÁN) --- */
function handleCameraButton() {
    resultsWrapper.innerHTML = ''; 
    input.value = '';
    if (isCameraRunning) forceStopCamera();
    else startCamera();
}

function startCamera() {
    readerDiv.style.display = 'block';
    camIcon.style.display = 'none';
    stopIcon.style.display = 'block';
    scanBtn.classList.add('active');

    if (html5QrCode === null) html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 20, qrbox: 200 },
        (decodedText) => {
            forceStopCamera().then(() => {
                input.value = decodedText;
                search(decodedText.trim().toUpperCase());
            });
        },
        () => {}
    ).then(() => { isCameraRunning = true; });
}

function forceStopCamera() {
    return new Promise((resolve) => {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                cleanupUI();
                resolve();
            }).catch(() => {
                cleanupUI();
                resolve();
            });
        } else {
            cleanupUI();
            resolve();
        }
    });
}

function cleanupUI() {
    html5QrCode = null;
    isCameraRunning = false;
    readerDiv.style.display = 'none';
    camIcon.style.display = 'block';
    stopIcon.style.display = 'none';
    scanBtn.classList.remove('active');
}

function playSound(ok) {
    const snd = document.getElementById(ok ? 'sndOk' : 'sndError');
    snd.currentTime = 0; snd.play().catch(()=>{});
}

init();
</script>
</body>
</html>
