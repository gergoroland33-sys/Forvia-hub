<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Forvia Bank Scan Pro V5.1</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- GLOBÁLIS DESIGN --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
    --bg: #0f172a;
    --card-bg: #1e293b;
    --accent: #3b82f6;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: rgba(255,255,255,0.1);
    --ok: #10b981;
    --err: #ef4444;
}

body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg); color: var(--text-main);
    margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
}

.header {
    flex-shrink: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border); padding: 15px; text-align: center;
    padding-top: max(15px, env(safe-area-inset-top));
}
.header h1 { margin: 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; }

.main-content {
    flex: 1; display: flex; flex-direction: column; padding: 15px;
    overflow-y: auto; align-items: center; width: 100%;
}

#reader {
    width: 100%; max-width: 280px; aspect-ratio: 1/1; border-radius: 24px;
    overflow: hidden; margin-bottom: 15px; border: 2px solid var(--accent);
    display: none; background: #000;
}

.input-area {
    width: 100%; max-width: 500px; display: flex; gap: 10px; margin-bottom: 20px;
}
input[type=text] {
    flex: 1; background: var(--card-bg); border: 1px solid var(--border);
    padding: 15px; border-radius: 12px; color: #fff; font-size: 1.1rem; outline: none;
}
.scan-btn {
    width: 55px; height: 55px; border-radius: 12px; border: none;
    background: var(--accent); display: flex; align-items: center; justify-content: center;
}

/* --- PRO EREDMÉNY PANEL --- */
.result-card {
    width: 100%; max-width: 500px; background: var(--card-bg);
    border-radius: 20px; border: 1px solid var(--border);
    overflow: hidden; animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.res-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border);
}
.res-item {
    background: var(--card-bg); padding: 20px 15px; text-align: center; display: flex; flex-direction: column; justify-content: center;
}
.res-full { grid-column: span 2; border-bottom: 1px solid var(--border); }

.label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
.value { font-size: 1.4rem; font-weight: 700; color: #fff; }
.highlight { color: #fbbf24; } /* Pozíció színe */

/* --- ELŐZMÉNYEK --- */
.footer-history {
    background: #0b1120; border-top: 1px solid var(--border); height: 180px;
    padding: 15px; overflow-y: auto;
}
.hist-head { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; }
.h-row {
    display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03);
    border-radius: 8px; margin-bottom: 5px; font-size: 0.85rem; border-left: 3px solid var(--accent);
}
.h-row.err { border-left-color: var(--err); }
</style>
</head>
<body>

<div class="header">
    <h1>Forvia Scan Pro</h1>
</div>

<div class="main-content">
    <div id="loadMsg" style="font-size:0.7rem; color:var(--text-muted); margin-bottom:10px;">Adatbázis töltése...</div>
    <div id="reader"></div>
    <div class="input-area">
        <input type="text" id="barcodeInput" placeholder="Vonalkód olvasás..." autocomplete="off">
        <button class="scan-btn" onclick="handleCameraButton()">
            <svg id="camIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
    </div>
    <div id="resultsWrapper"></div>
</div>

<div class="footer-history">
    <div class="hist-head"><span>Előzmények</span><span onclick="clearHistory()" style="color:var(--err); cursor:pointer;">Törlés</span></div>
    <div id="historyList"></div>
</div>

<audio id="sndOk" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>
<audio id="sndError" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
const input = document.getElementById('barcodeInput');
const resultsWrapper = document.getElementById('resultsWrapper');
const historyList = document.getElementById('historyList');
const loadMsg = document.getElementById('loadMsg');
let html5QrCode = null, isCameraRunning = false, bankDB = [];

async function init() {
    await loadBankCSV();
    renderHistory();
}

async function loadBankCSV() {
    try {
        const res = await fetch('bank.csv');
        const data = await res.text();
        const lines = data.split('\n');
        const headers = lines[0].split(';');
        let modelIdx = headers.findIndex(h => h.trim().toLowerCase().includes('model'));

        lines.slice(1).forEach(line => {
            const cols = line.split(';');
            if (cols.length < 2) return;
            bankDB.push({
                gep: cols[0]?.trim() || "N/A",
                poz: cols[1]?.trim() || "N/A",
                id: cols[2]?.trim().toUpperCase() || "",
                msd: cols[4]?.trim() || "N/A",
                model: (modelIdx !== -1 && cols[modelIdx]) ? cols[modelIdx].trim() : "BANK"
            });
        });
        loadMsg.innerText = `ADATBÁZIS: ${bankDB.length} TÉTEL`;
    } catch (e) { loadMsg.innerText = "HIBA: bank.csv!"; }
}

input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const code = input.value.trim().toUpperCase();
        if (code) search(code);
        input.value = ''; input.blur();
    }
});

function search(code) {
    resultsWrapper.innerHTML = '';
    const matches = bankDB.filter(i => (code.includes(i.id) || i.id.includes(code)) && i.id.length > 2);

    if (matches.length > 0) {
        playSound(true);
        matches.forEach(m => {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div class="res-grid">
                    <div class="res-item res-full"><div class="label">Modell</div><div class="value">${m.model}</div></div>
                    <div class="res-item"><div class="label">Gép</div><div class="value">${m.gep}</div></div>
                    <div class="res-item"><div class="label">Pozíció</div><div class="value highlight">#${m.poz}</div></div>
                    <div class="res-item"><div class="label">Azonosító (ID)</div><div class="value" style="font-size:1rem; word-break:break-all;">${m.id}</div></div>
                    <div class="res-item"><div class="label">MSD</div><div class="value" style="color:#10b981;">${m.msd}</div></div>
                </div>
            `;
            resultsWrapper.appendChild(card);
            saveToHistory(code, m.gep, true);
        });
    } else {
        playSound(false);
        resultsWrapper.innerHTML = '<div style="color:var(--err); font-weight:bold; text-align:center; padding:20px;">NINCS A LISTÁBAN</div>';
        saveToHistory(code, "Hiba", false);
    }
}

function saveToHistory(code, res, ok) {
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    history.unshift({ code, res, ok, time });
    if(history.length > 50) history.pop();
    localStorage.setItem('scanHistory', JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    historyList.innerHTML = history.map(item => `
        <div class="h-row ${item.ok ? '' : 'err'}">
            <span style="color:var(--text-muted); margin-right:10px;">${item.time}</span>
            <span style="flex:1;">${item.code}</span>
            <span style="font-weight:bold;">${item.res}</span>
        </div>
    `).join('');
}

function clearHistory() {
    if(confirm("Törlöd az előzményeket?")) {
        localStorage.removeItem('scanHistory');
        renderHistory();
    }
}

function handleCameraButton() {
    const reader = document.getElementById('reader');
    if (isCameraRunning) {
        html5QrCode.stop().then(() => { reader.style.display='none'; isCameraRunning=false; });
    } else {
        reader.style.display='block';
        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 220 }, (txt) => {
            html5QrCode.stop().then(() => {
                reader.style.display='none'; isCameraRunning=false;
                input.value = txt; search(txt.toUpperCase());
            });
        }).then(() => isCameraRunning = true);
    }
}

function playSound(ok) {
    const snd = document.getElementById(ok ? 'sndOk' : 'sndError');
    snd.currentTime = 0; snd.play().catch(()=>{});
}

init();
</script>
</body>
</html>
