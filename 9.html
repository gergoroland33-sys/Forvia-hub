<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Forvia Scan V7.2 (Stable Fix)</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- GLOBÁLIS DESIGN (Változatlan, mert szép volt) --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
    --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --accent: #3b82f6;
    --accent-glow: rgba(59, 130, 246, 0.5);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --ok-color: #10b981;
    --err-color: #ef4444;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-gradient); color: var(--text-main);
    margin: 0; padding: 0; width: 100%; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
}

/* --- FEJLÉC --- */
.header {
    flex-shrink: 0; width: 100%; background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
    padding: 15px 20px; text-align: center; z-index: 100;
    padding-top: max(15px, env(safe-area-inset-top)); 
}
.header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: white; }
.header .credits { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; font-weight: 500; }
.header .credits span { color: var(--accent); }

/* --- TARTALOM --- */
.main-content {
    flex: 1; display: flex; flex-direction: column; padding: 20px;
    overflow-y: auto; align-items: center; width: 100%; -webkit-overflow-scrolling: touch;
}

/* --- KAMERA PANEL --- */
.settings-box {
    width: 100%; max-width: 320px; margin-bottom: 20px;
    background: rgba(30, 41, 59, 0.7); 
    border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 15px;
    backdrop-filter: blur(5px);
    display: flex; flex-direction: column; gap: 12px;
}

.select-wrapper { position: relative; width: 100%; }
.select-wrapper::after {
    content: '▼'; font-size: 0.7rem; color: var(--accent);
    position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none;
}
select#cameraSelect {
    width: 100%; appearance: none; -webkit-appearance: none;
    background: #0f172a; color: white; 
    border: 1px solid var(--glass-border);
    padding: 10px 15px; padding-right: 35px;
    border-radius: 12px; font-size: 0.85rem; font-weight: 500;
    outline: none;
}

.slider-group { display: flex; flex-direction: column; gap: 6px; }
.slider-header {
    display: flex; justify-content: space-between; font-size: 0.75rem; 
    color: var(--text-muted); font-weight: 700; text-transform: uppercase;
}
.slider-val { color: var(--accent); }

input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #475569; border-radius: 3px; }
input[type=range]::-webkit-slider-thumb {
    height: 18px; width: 18px; border-radius: 50%;
    background: var(--accent); margin-top: -6px; 
    box-shadow: 0 0 10px var(--accent-glow); border: 2px solid white; -webkit-appearance: none;
}

/* --- KAMERA DOBOZ --- */
#reader {
    width: 100%; max-width: 300px; aspect-ratio: 1 / 1; border-radius: 20px;
    overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border: 3px solid var(--accent); display: none; background: black; flex-shrink: 0;
}
#reader video { width: 100% !important; height: 100% !important; object-fit: cover; }

/* INPUT */
.input-wrapper { width: 100%; max-width: 500px; display: flex; gap: 12px; margin-bottom: 25px; flex-shrink: 0; }
input[type=text] {
    flex: 1; background: var(--glass); border: 1px solid var(--glass-border);
    padding: 16px 20px; border-radius: 16px; color: white; font-size: 1.2rem;
    font-weight: 600; text-align: center; outline: none; backdrop-filter: blur(5px); min-width: 0;
}
.scan-btn {
    width: 60px; height: 60px; border-radius: 16px; border: none;
    background: var(--accent); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px var(--accent-glow); flex-shrink: 0; transition: all 0.2s;
}
.scan-btn:active { transform: scale(0.92); }
.scan-btn svg { width: 28px; height: 28px; fill: white; }
.scan-btn.active { background: var(--err-color); }

/* --- EREDMÉNYEK --- */
#resultsWrapper { width: 100%; max-width: 500px; padding-bottom: 20px; }
.result-card {
    background: #1e293b; border: 1px solid var(--glass-border);
    border-radius: 20px; overflow: hidden; margin-bottom: 15px;
    animation: popIn 0.3s ease-out; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--glass-border); }
.res-cell { background: #1e293b; padding: 15px 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.res-full { grid-column: span 2; border-bottom: 1px solid var(--glass-border); }
.res-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
.res-value { font-size: 1.1rem; font-weight: 800; color: white; word-break: break-all; line-height: 1.2; }
.res-highlight { color: #fbbf24; font-size: 1.4rem; } 
.res-ok { color: var(--ok-color); }
.no-result { font-size: 1.5rem; font-weight: bold; color: var(--err-color); text-align: center; margin-top: 20px; }
.load-msg { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; }

/* --- FOOTER --- */
.footer-history {
    background: rgba(15, 23, 42, 0.95); border-top: 1px solid var(--glass-border);
    height: 150px; flex-shrink: 0; overflow-y: auto; padding: 15px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
}
.history-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
.history-title { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }
.clear-btn { color: var(--err-color); font-size: 0.75rem; cursor: pointer; text-transform: uppercase; font-weight: bold; border: 1px solid var(--err-color); padding: 2px 8px; border-radius: 4px; }
.h-item { display: flex; align-items: center; justify-content: flex-start; gap: 30px; padding: 8px 12px; margin-bottom: 6px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 0.85rem; border-left: 3px solid #555; }
.h-ok { border-left-color: var(--ok-color); }
.h-err { border-left-color: var(--err-color); }
.h-time { font-size: 0.75rem; color: #64748b; font-weight: bold; white-space: nowrap; }
</style>
</head>
<body>

<div class="header">
    <h1>Forvia Scan V7.2</h1>
    <div class="credits">Készítette: <span>Gergő Roland</span></div>
</div>

<div class="main-content">
    <div id="loadMsg" class="load-msg">Adatbázis betöltése...</div>

    <div class="settings-box">
        <div class="select-wrapper">
            <select id="cameraSelect">
                <option value="auto">Auto (Eredeti stabil mód)</option>
            </select>
        </div>
        
        <div class="slider-group">
            <div class="slider-header">
                <span>Keret mérete</span>
                <span id="sliderValueDisplay">200px</span>
            </div>
            <input type="range" id="boxSizeSlider" min="100" max="350" step="10" value="200">
        </div>
    </div>

    <div id="reader"></div>

    <div class="input-wrapper">
        <input type="text" id="barcodeInput" placeholder="Kód..." autocomplete="off">
        <button class="scan-btn" onclick="toggleCamera()" title="Kamera indítása">
            <svg id="camIcon" viewBox="0 0 24 24">
                <path d="M4 6h2v12H4zm14 0h2v12h-2zm-4 0h2v12h-2zm-4 0h2v12h-2zM2 4v16h20V4H2zm18 14H4V6h16v12z"/>
                <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
            <svg id="stopIcon" viewBox="0 0 24 24" style="display:none;">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    </div>

    <div id="resultsWrapper"></div>
</div>

<div class="footer-history">
    <div class="history-header">
        <span class="history-title">Előzmények</span>
        <span class="clear-btn" onclick="clearHistory()">Törlés</span>
    </div>
    <div id="historyList"></div>
</div>

<audio id="sndOk" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>
<audio id="sndError" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/* ========================================================
   LOGIKA V7.2 - STABILIOS JAVÍTÁS + SZIGORÚ SZŰRÉS
   ======================================================== */
const input = document.getElementById('barcodeInput');
const resultsWrapper = document.getElementById('resultsWrapper');
const historyList = document.getElementById('historyList');
const loadMsg = document.getElementById('loadMsg');
const camIcon = document.getElementById('camIcon');
const stopIcon = document.getElementById('stopIcon');
const scanBtn = document.querySelector('.scan-btn');
const readerDiv = document.getElementById('reader');

// Beállítások
const boxSizeSlider = document.getElementById('boxSizeSlider');
const sliderValueDisplay = document.getElementById('sliderValueDisplay');
const cameraSelect = document.getElementById('cameraSelect');

let html5QrCode = null;
let isCameraRunning = false;
let bankDB = [];
let availableCameras = [];

// --- SLIDER ---
const savedSize = localStorage.getItem('scanBoxSize');
if(savedSize) {
    boxSizeSlider.value = savedSize;
    sliderValueDisplay.innerText = savedSize + "px";
}

boxSizeSlider.addEventListener('input', (e) => {
    const newVal = e.target.value;
    sliderValueDisplay.innerText = newVal + "px";
    localStorage.setItem('scanBoxSize', newVal);
    if(isCameraRunning) {
        if(this.restartTimeout) clearTimeout(this.restartTimeout);
        this.restartTimeout = setTimeout(() => {
            stopCameraInternal().then(() => startCameraInternal());
        }, 500);
    }
});

// --- KAMERA LISTA ESEMÉNY ---
cameraSelect.addEventListener('change', () => {
    const selectedId = cameraSelect.value;
    if (selectedId === 'auto') {
        localStorage.removeItem('selectedCameraId');
    } else {
        localStorage.setItem('selectedCameraId', selectedId);
    }
    
    // Csak akkor váltunk, ha már fut a kamera
    if (isCameraRunning) {
        stopCameraInternal().then(() => startCameraInternal());
    }
});

async function init() {
    await loadBankCSV();
    if(bankDB.length > 0) {
        loadMsg.innerText = `Adatbázis kész: ${bankDB.length} tétel`;
        loadMsg.style.color = "#10b981";
    }
    renderHistory();
    // Nem hívunk updateCameraList-et itt, hogy ne kavarjon be az indulásnál
    // Majd a kamera start után töltjük be, amikor már van engedély.
}

// --- KAMERÁK FELTÉRKÉPEZÉSE (SZIGORÚ SZŰRÉS) ---
function updateCameraList() {
    Html5Qrcode.getCameras().then(devices => {
        if (!devices || !devices.length) return;
        
        // Ha ugyanaz a lista, nem rajzoljuk újra
        if(availableCameras.length === devices.length) return;
        availableCameras = devices;

        const savedId = localStorage.getItem('selectedCameraId');
        let html = '<option value="auto">Auto (Eredeti stabil mód)</option>';
        
        devices.forEach(camera => {
            const label = (camera.label || "").toLowerCase();
            
            // --- JAVÍTOTT SZŰRÉS ---
            // Kiveszünk mindent ami: front, elülső, elöl, selfie, user
            if (label.includes('front') || 
                label.includes('elülső') || 
                label.includes('elöl') || 
                label.includes('selfie') || 
                label.includes('user')) {
                return; 
            }
            
            const isSelected = (savedId === camera.id) ? 'selected' : '';
            // Rövidítjük a nevet ha túl hosszú
            let displayLabel = camera.label || `Kamera ${camera.id.substr(0,4)}`;
            if(displayLabel.length > 35) displayLabel = displayLabel.substr(0,34) + "..";
            
            html += `<option value="${camera.id}" ${isSelected}>${displayLabel}</option>`;
        });
        
        cameraSelect.innerHTML = html;
        
    }).catch(err => {
        console.log("Még nincs lista hozzáférés");
    });
}

async function loadBankCSV() {
    try {
        const res = await fetch('bank.csv');
        const data = await res.text();
        const lines = data.split('\n');
        const headers = lines[0].split(';');
        let modelIdx = headers.findIndex(h => h.trim().toLowerCase().includes('model'));

        lines.slice(1).forEach(line => {
            const cols = line.split(';');
            if (cols.length < 2) return;
            bankDB.push({
                gep: cols[0]?.trim() || "N/A",
                poz: cols[1]?.trim() || "N/A",
                id: cols[2]?.trim().toUpperCase() || "",
                msd: cols[4]?.trim() || "N/A",
                model: (modelIdx !== -1 && cols[modelIdx]) ? cols[modelIdx].trim() : "BANK"
            });
        });
    } catch (e) { 
        loadMsg.innerText = "HIBA: bank.csv nem található!";
        loadMsg.style.color = "#ef4444";
    }
}

input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const code = input.value.trim().toUpperCase();
        if (code) search(code);
        input.value = ''; input.blur();
    }
});

function search(code) {
    resultsWrapper.innerHTML = '';
    const matches = bankDB.filter(i => (code.includes(i.id) || i.id.includes(code)) && i.id.length > 2);

    if (matches.length > 0) {
        playSound(true);
        matches.forEach(m => {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div class="res-grid">
                    <div class="res-cell res-full">
                        <span class="res-label">Modell</span><span class="res-value">${m.model}</span>
                    </div>
                    <div class="res-cell">
                        <span class="res-label">Gép</span><span class="res-value">${m.gep}</span>
                    </div>
                    <div class="res-cell">
                        <span class="res-label">Pozíció</span><span class="res-value res-highlight">#${m.poz}</span>
                    </div>
                    <div class="res-cell">
                        <span class="res-label">Azonosító</span><span class="res-value" style="font-size:0.9rem;">${m.id}</span>
                    </div>
                    <div class="res-cell">
                        <span class="res-label">MSD</span><span class="res-value res-ok">${m.msd}</span>
                    </div>
                </div>`;
            resultsWrapper.appendChild(card);
        });
        saveToHistory(code, true);
    } else {
        playSound(false);
        resultsWrapper.innerHTML = '<div class="no-result">NINCS A LISTÁBAN</div>';
        saveToHistory(code, false);
    }
}

// --- KAMERA VEZÉRLÉS (STABILITÁS JAVÍTVA) ---
function toggleCamera() {
    resultsWrapper.innerHTML = ''; input.value = '';
    if (isCameraRunning) {
        stopCameraInternal();
    } else {
        startCameraInternal();
    }
}

async function startCameraInternal(forceAuto = false) {
    readerDiv.style.display = 'block';
    camIcon.style.display = 'none'; stopIcon.style.display = 'block';
    scanBtn.classList.add('active');

    if (html5QrCode === null) {
        html5QrCode = new Html5Qrcode("reader");
    }

    const currentBoxSize = parseInt(boxSizeSlider.value);
    // Ha forceAuto igaz, akkor ignoráljuk a mentést
    const savedCamId = forceAuto ? 'auto' : localStorage.getItem('selectedCameraId');
    
    // --- KONFIGURÁCIÓ ---
    // Az "environment" beállítás a legstabilabb iOS-en.
    // Csak akkor váltunk deviceId-ra, ha a felhasználó kifejezetten kért mást.
    let constraints;
    if (savedCamId && savedCamId !== 'auto') {
        constraints = { deviceId: { exact: savedCamId } };
    } else {
        // Ez az "Eredeti kód" beállítása, ami működött!
        constraints = { facingMode: "environment" }; 
    }

    const config = { 
        fps: 25, 
        qrbox: { width: currentBoxSize, height: currentBoxSize },
        formatsToSupport: [ Html5QrcodeSupportedFormats.DATA_MATRIX ] 
    };

    try {
        await html5QrCode.start(
            constraints, 
            config,
            (decodedText) => {
                stopCameraInternal().then(() => {
                    input.value = decodedText;
                    search(decodedText.trim().toUpperCase());
                });
            },
            (err) => {}
        );
        isCameraRunning = true;
        
        // Ha sikeres a start, akkor kérjük le a listát (mert már van engedély)
        updateCameraList();
        
    } catch (err) {
        console.error("Kamera hiba:", err);
        
        // --- HIBAKEZELÉS / AUTOMATIKUS JAVÍTÁS ---
        // Ha nem sikerült elindítani a választott kamerát, akkor azonnal
        // visszaváltunk a biztonságos "Auto" módra.
        if (!forceAuto && savedCamId && savedCamId !== 'auto') {
            console.log("Választott kamera hiba -> Visszaállás Auto módra");
            localStorage.removeItem('selectedCameraId');
            cameraSelect.value = 'auto';
            // Újrapróbáljuk Auto módban
            await stopCameraInternal();
            return startCameraInternal(true); 
        } else {
            // Ha már auto módban is hiba van
            alert("Kamera hozzáférési hiba. Ellenőrizd az engedélyeket.");
            stopCameraInternal();
        }
    }
}

function stopCameraInternal() {
    return new Promise((resolve) => {
        if (html5QrCode && isCameraRunning) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                cleanupUI();
                resolve();
            }).catch(() => {
                cleanupUI();
                resolve();
            });
        } else {
            cleanupUI();
            resolve();
        }
    });
}

function cleanupUI() {
    isCameraRunning = false;
    readerDiv.style.display = 'none';
    camIcon.style.display = 'block'; stopIcon.style.display = 'none';
    scanBtn.classList.remove('active');
}

function playSound(ok) {
    const snd = document.getElementById(ok ? 'sndOk' : 'sndError');
    snd.currentTime = 0; snd.play().catch(()=>{});
}

function saveToHistory(code, ok) {
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    history.unshift({ code, ok, time });
    if(history.length > 30) history.pop();
    localStorage.setItem('scanHistory', JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
    historyList.innerHTML = history.map(item => `
        <div class="h-item ${item.ok ? 'h-ok' : 'h-err'}">
            <span class="h-time">${item.time}</span>
            <span><b>${item.code}</b></span>
        </div>
    `).join('');
}

function clearHistory() {
    if(confirm("Törlöd az előzményeket?")) {
        localStorage.removeItem('scanHistory');
        renderHistory();
    }
}

function checkAutoStart() {
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('autostart') === 'true') {
        setTimeout(() => { if(!isCameraRunning) toggleCamera(); }, 500); 
    }
}

init().then(() => checkAutoStart());
</script>
</body>
</html>
