<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forvia SMT Managerial Dashboard</title>
<style>
/* --- PRO DESIGN SYSTEM --- */
:root {
    --bg-app: #0f172a;       /* S√∂t√©tk√©k h√°tt√©r */
    --bg-card: #1e293b;      /* K√°rtya h√°tt√©r */
    --primary: #3b82f6;      /* Forvia K√©k */
    --text-main: #f8fafc;    /* Feh√©r sz√∂veg */
    --text-muted: #94a3b8;   /* Sz√ºrke sz√∂veg */
    --danger: #ef4444;       /* Piros (Pick hiba) */
    --warning: #f59e0b;      /* S√°rga (Vision hiba) */
    --success: #10b981;      /* Z√∂ld (Yield) */
    --border: #334155;       /* Keret */
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-main);
    margin: 0; padding: 20px;
    font-size: 14px;
}

.container { max-width: 1400px; margin: 0 auto; }

/* HEADER */
header {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px;
}
.brand h1 { margin: 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; color: white; }
.brand span { color: var(--primary); font-weight: 900; }
.brand .subtitle { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-top: 5px; }

/* CONTROLS & FILTER */
.controls-area {
    display: flex; gap: 15px; margin-bottom: 25px; align-items: stretch;
}
.upload-btn {
    background: var(--primary); color: white; border: none; padding: 0 25px;
    border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center;
    transition: 0.2s;
}
.upload-btn:hover { background: #2563eb; }

.filter-bar {
    display: flex; gap: 10px; background: var(--bg-card);
    padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); flex: 1;
}
.filter-group { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.filter-group label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
select {
    background: var(--bg-app); color: white; border: 1px solid var(--border);
    padding: 8px; border-radius: 4px; font-size: 0.9rem; width: 100%;
}

/* KPI CARDS (Managerial Level) */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
.kpi-card {
    background: var(--bg-card); padding: 20px; border-radius: 10px;
    border: 1px solid var(--border); position: relative; overflow: hidden;
}
.kpi-card h3 { margin: 0 0 10px 0; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
.kpi-value { font-size: 2rem; font-weight: 800; display: block; line-height: 1; }
.kpi-sub { font-size: 0.85rem; margin-top: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
.badge-ppm {
    background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;
}

/* ANALYSIS PANELS */
.analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.panel { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
.panel-header {
    padding: 15px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.15);
}
.panel-title { font-size: 1rem; font-weight: 700; text-transform: uppercase; margin: 0; display: flex; align-items: center; gap: 10px; }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* Critical Alert Banner inside Panel */
.alert-banner {
    margin: 15px 15px 5px 15px; padding: 10px 15px; border-radius: 6px;
    font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;
    border-left: 4px solid;
}

/* TABLE */
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { text-align: left; padding: 12px 15px; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
td { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); vertical-align: middle; }

.item-name { font-weight: 700; font-size: 0.95rem; color: #fff; display: block; }
.item-loc { font-size: 0.75rem; color: var(--primary); margin-top: 2px; display: inline-block; background: rgba(59, 130, 246, 0.1); padding: 2px 6px; border-radius: 4px; }
.stat-primary { font-weight: 800; font-size: 1rem; text-align: right; }
.stat-secondary { font-size: 0.75rem; color: var(--text-muted); text-align: right; margin-top: 2px; }

/* PROGRESS BAR IN TABLE */
.prog-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 2px; }

/* PRINT STYLES (A4 ONE PAGE) */
@media print {
    @page { size: A4 landscape; margin: 5mm; }
    body { 
        background: white !important; color: black !important; padding: 0 !important; zoom: 68% !important; 
        -webkit-print-color-adjust: exact !important;
    }
    .controls-area { display: none !important; }
    .container { max-width: 100% !important; }
    
    /* Colors for Print */
    .brand h1 { color: black !important; }
    .kpi-card, .panel { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; }
    .panel-header { background: #f0f0f0 !important; border-bottom: 1px solid #ccc !important; }
    .item-name { color: #000 !important; }
    td { border-bottom: 1px solid #eee !important; }
    .item-loc { background: #eff6ff !important; color: #1d4ed8 !important; border: 1px solid #bfdbfe; }
    
    /* Stat colors override for print readability */
    .text-danger { color: #dc2626 !important; }
    .text-warning { color: #d97706 !important; }
    .text-success { color: #059669 !important; }
}

/* UTILS */
.text-danger { color: var(--danger); }
.text-warning { color: var(--warning); }
.text-success { color: var(--success); }
.bg-danger-sub { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: var(--danger); }
.bg-warning-sub { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-color: var(--warning); }
</style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <h1>Forvia <span>SMT Analytics</span></h1>
            <div class="subtitle">Production Quality & Attrition Report</div>
        </div>
        <div style="text-align:right">
            <div id="reportDate" style="font-weight:bold; font-size:0.9rem;">2024-05-15</div>
            <div style="font-size:0.8rem; color:var(--text-muted)">Generated by QA Pro</div>
        </div>
    </header>

    <div class="controls-area">
        <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
            üìÇ Adatf√°jl Bet√∂lt√©se (CSV)
        </div>
        <input type="file" id="fileInput" accept=".csv,.txt" style="display:none">

        <div class="filter-bar">
            <div class="filter-group">
                <label>G√©psor (Line)</label>
                <select id="filterLine" onchange="filterLineChanged()"><option value="mind">Teljes Gy√°r</option></select>
            </div>
            <div class="filter-group">
                <label>Be√ºltet≈ë G√©p (Machine)</label>
                <select id="filterMachine" onchange="updateView()"><option value="mind">Minden G√©p</option></select>
            </div>
            <div class="filter-group">
                <label>Toplista M√©ret</label>
                <select id="topLimit" onchange="updateView()">
                    <option value="5">Top 5 (F√≥kusz)</option>
                    <option value="10" selected>Top 10 (Norm√°l)</option>
                    <option value="15">Top 15 (R√©szletes)</option>
                </select>
            </div>
        </div>
        <button onclick="window.print()" style="background:#334155; color:white; border:none; padding:0 20px; border-radius:6px; cursor:pointer; font-weight:bold;">üñ®Ô∏è PDF</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card" style="border-top: 4px solid var(--primary);">
            <h3>Gy√°rtott Mennyis√©g</h3>
            <span class="kpi-value" id="kpiTotal">0</span>
            <div class="kpi-sub" style="color:var(--text-muted)">Be√ºltetett alkatr√©sz</div>
        </div>
        
        <div class="kpi-card" style="border-top: 4px solid var(--success);">
            <h3>First Pass Yield (Kihozatal)</h3>
            <span class="kpi-value text-success" id="kpiYield">100%</span>
            <div class="kpi-sub">Folyamat hat√©konys√°g</div>
        </div>

        <div class="kpi-card" style="border-top: 4px solid var(--danger);">
            <h3>Felv√©teli Hiba (Pick)</h3>
            <span class="kpi-value text-danger" id="kpiPickRate">0.00%</span>
            <div class="kpi-sub text-danger">
                <span id="kpiPickPPM" class="badge-ppm">0 PPM</span>
                <span>vesztes√©g</span>
            </div>
        </div>

        <div class="kpi-card" style="border-top: 4px solid var(--warning);">
            <h3>Felismer√©si Hiba (Vision)</h3>
            <span class="kpi-value text-warning" id="kpiVisRate">0.00%</span>
            <div class="kpi-sub text-warning">
                <span id="kpiVisPPM" class="badge-ppm">0 PPM</span>
                <span>vesztes√©g</span>
            </div>
        </div>
    </div>

    <div class="analysis-grid">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title text-danger"><span class="dot" style="background:var(--danger)"></span> KRITIKUS FELV√âTELI HIB√ÅK</h3>
            </div>
            <div id="alertPick" class="alert-banner bg-danger-sub" style="display:none"></div>
            <table id="tablePick">
                <thead><tr><th>Alkatr√©sz / Feeder Poz√≠ci√≥</th><th style="text-align:right">Elsz√≥r√≥d√°s / Ar√°ny</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title text-warning"><span class="dot" style="background:var(--warning)"></span> KRITIKUS FELISMER√âSI HIB√ÅK</h3>
            </div>
            <div id="alertVis" class="alert-banner bg-warning-sub" style="display:none"></div>
            <table id="tableVis">
                <thead><tr><th>Alkatr√©sz / Feeder Poz√≠ci√≥</th><th style="text-align:right">Elsz√≥r√≥d√°s / Ar√°ny</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* --- ADATKEZEL√âS √âS LOGIKA --- */
let rawData = [];
let lineMachineMap = {}; // Strukt√∫ra: { "Line1": ["G√©pA", "G√©pB"], "Line2": [...] }

// 1. D√°tum be√°ll√≠t√°sa
document.getElementById('reportDate').innerText = new Date().toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric' });

// 2. F√°jl Beolvas√°s
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
        const text = ev.target.result;
        processData(text);
    };
    reader.readAsText(file);
});

function processData(csvText) {
    const lines = csvText.split('\n').map(x => x.trim()).filter(x => x);
    if(lines.length < 2) return;

    // Automatikus elv√°laszt√≥ detekt√°l√°s (; vagy ,)
    const sep = lines[0].indexOf(';') > -1 ? ';' : ',';
    
    rawData = [];
    lineMachineMap = {};

    // Adatok bet√∂lt√©se √©s T√©rk√©p √©p√≠t√©se
    for(let i=1; i<lines.length; i++) {
        const col = lines[i].split(sep);
        if(col.length < 4) continue;

        const line = col[0] ? col[0].trim() : "Egy√©b";
        const machine = col[1] ? col[1].trim() : "Egy√©b";
        
        // T√©rk√©p √©p√≠t√©se a dropdownhoz
        if(!lineMachineMap[line]) lineMachineMap[line] = new Set();
        lineMachineMap[line].add(machine);

        rawData.push({
            line: line,
            machine: machine,
            part: col[2] ? col[2].trim() : "Unknown",
            good: parseInt(col[3]) || 0,
            pickErr: parseInt(col[4]) || 0,
            visErr: parseInt(col[5]) || 0
        });
    }

    initFilters();
    updateView();
}

function initFilters() {
    const lineSelect = document.getElementById('filterLine');
    lineSelect.innerHTML = '<option value="mind">Teljes Gy√°r (√ñsszes)</option>';
    
    Object.keys(lineMachineMap).sort().forEach(line => {
        lineSelect.innerHTML += `<option value="${line}">${line}</option>`;
    });

    // Reset machine filter
    filterLineChanged(); 
}

// 3. Intelligens Sz≈±r√©s (Ez volt a k√©r√©sed!)
function filterLineChanged() {
    const selectedLine = document.getElementById('filterLine').value;
    const machineSelect = document.getElementById('filterMachine');
    
    machineSelect.innerHTML = '<option value="mind">Minden G√©p</option>';
    
    if (selectedLine !== 'mind' && lineMachineMap[selectedLine]) {
        // Csak a v√°lasztott sorhoz tartoz√≥ g√©pek
        const machines = Array.from(lineMachineMap[selectedLine]).sort();
        machines.forEach(m => {
            machineSelect.innerHTML += `<option value="${m}">${m}</option>`;
        });
    } else {
        // Ha "Teljes Gy√°r", akkor az √∂sszes l√©tez≈ë g√©p
        const allMachines = new Set();
        Object.values(lineMachineMap).forEach(s => s.forEach(m => allMachines.add(m)));
        Array.from(allMachines).sort().forEach(m => {
            machineSelect.innerHTML += `<option value="${m}">${m}</option>`;
        });
    }
    updateView();
}

// 4. Sz√°m√≠t√°s √©s Megjelen√≠t√©s (Menedzseri logika)
function updateView() {
    if(rawData.length === 0) return;

    const sLine = document.getElementById('filterLine').value;
    const sMach = document.getElementById('filterMachine').value;
    const limit = parseInt(document.getElementById('topLimit').value);

    // Sz≈±r√©s
    const data = rawData.filter(d => 
        (sLine === 'mind' || d.line === sLine) &&
        (sMach === 'mind' || d.machine === sMach)
    );

    // Aggreg√°l√°s
    let sumGood = 0, sumPick = 0, sumVis = 0;
    let pickByPart = {}, visByPart = {};
    let locByPart = {}; // Hol fordult el≈ë?

    data.forEach(d => {
        sumGood += d.good;
        sumPick += d.pickErr;
        sumVis += d.visErr;

        if(d.pickErr > 0) pickByPart[d.part] = (pickByPart[d.part] || 0) + d.pickErr;
        if(d.visErr > 0) visByPart[d.part] = (visByPart[d.part] || 0) + d.visErr;

        if(d.pickErr > 0 || d.visErr > 0) {
            if(!locByPart[d.part]) locByPart[d.part] = new Set();
            locByPart[d.part].add(`${d.machine} (${d.line})`);
        }
    });

    // MENEDZSERI KPI SZ√ÅM√çT√ÅS (Jav√≠tott k√©pletek!)
    // Total Usage = Good + PickErrors + VisionErrors (Minden, amit elhaszn√°ltunk a tekercsr≈ël)
    const totalUsage = sumGood + sumPick + sumVis;

    // Pick Rate: Hiba / Total Usage
    const pickRate = totalUsage > 0 ? (sumPick / totalUsage) * 100 : 0;
    const pickPPM = totalUsage > 0 ? Math.round((sumPick / totalUsage) * 1000000) : 0;

    // Vision Rate: Hiba / Total Usage (Anyagvesztes√©g szeml√©let)
    const visRate = totalUsage > 0 ? (sumVis / totalUsage) * 100 : 0;
    const visPPM = totalUsage > 0 ? Math.round((sumVis / totalUsage) * 1000000) : 0;

    // Yield (FPY): Good / Total Usage
    const yieldVal = totalUsage > 0 ? (sumGood / totalUsage) * 100 : 100;

    // DOM Update
    document.getElementById('kpiTotal').innerText = sumGood.toLocaleString();
    document.getElementById('kpiYield').innerText = yieldVal.toFixed(2) + "%";
    
    document.getElementById('kpiPickRate').innerText = pickRate.toFixed(2) + "%";
    document.getElementById('kpiPickPPM').innerText = pickPPM.toLocaleString() + " PPM";
    
    document.getElementById('kpiVisRate').innerText = visRate.toFixed(2) + "%";
    document.getElementById('kpiVisPPM').innerText = visPPM.toLocaleString() + " PPM";

    // T√°bl√°zatok renderel√©se
    renderTable('tablePick', pickByPart, locByPart, sumPick, limit, 'alertPick', 'text-danger', 'var(--danger)');
    renderTable('tableVis', visByPart, locByPart, sumVis, limit, 'alertVis', 'text-warning', 'var(--warning)');
}

function renderTable(tableId, dataMap, locMap, totalErr, limit, alertId, textClass, colorVar) {
    const tbody = document.getElementById(tableId).querySelector('tbody');
    tbody.innerHTML = "";
    
    // Rendez√©s cs√∂kken≈ë sorrendbe
    const sorted = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
    
    // Top Hiba Kiemel√©s (Badge)
    const alertEl = document.getElementById(alertId);
    if(sorted.length > 0) {
        const topItem = sorted[0];
        const topShare = totalErr > 0 ? ((topItem[1] / totalErr) * 100).toFixed(1) : 0;
        alertEl.style.display = "flex";
        alertEl.innerHTML = `
            <span><strong>TOP PROBL√âMA:</strong> ${topItem[0]}</span>
            <span>A hib√°k <strong>${topShare}%</strong>-a!</span>
        `;
    } else {
        alertEl.style.display = "none";
    }

    // Sorok gener√°l√°sa
    const maxVal = sorted.length > 0 ? sorted[0][1] : 1;
    
    sorted.slice(0, limit).forEach((item, idx) => {
        const part = item[0];
        const count = item[1];
        
        // Helysz√≠nek form√°z√°sa (max 3, ut√°na "...")
        const locs = Array.from(locMap[part] || ["N/A"]);
        let locString = locs.slice(0, 3).join(", ");
        if(locs.length > 3) locString += `, +${locs.length - 3} g√©p`;

        // Share % (Pareto)
        const share = totalErr > 0 ? ((count / totalErr) * 100).toFixed(1) : "0.0";

        tbody.innerHTML += `
        <tr>
            <td>
                <span class="item-name">${idx+1}. ${part}</span>
                <span class="item-loc">üìç ${locString}</span>
                <div class="prog-track">
                    <div class="prog-fill" style="width:${(count/maxVal)*100}%; background:${colorVar}"></div>
                </div>
            </td>
            <td style="vertical-align:top">
                <div class="stat-primary ${textClass}">${count.toLocaleString()} db</div>
                <div class="stat-secondary">√ñssz. hiba ${share}%-a</div>
            </td>
        </tr>
        `;
    });
}
</script>

</body>
</html>
