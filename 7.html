<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forvia SMT Managerial Dashboard v3.7 Pro</title>
<style>
/* --- EREDETI DESIGN SYSTEM (√âRINTETLEN) --- */
:root {
    --bg-app: #0f172a;       
    --bg-card: #1e293b;      
    --bg-modal: rgba(15, 23, 42, 0.98); 
    --primary: #3b82f6;      
    --text-main: #f8fafc;    
    --text-muted: #94a3b8;   
    --danger: #ef4444;       
    --warning: #f59e0b;      
    --success: #10b981;      
    --border: #334155; 
    --purple: #8b5cf6; /* √öj sz√≠n a gombhoz */      
}

* { box-sizing: border-box; }

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-main);
    margin: 0; padding: 15px;
    font-size: 14px;
}

.container { max-width: 1400px; margin: 0 auto; }

/* HEADER */
header {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 20px;
    flex-wrap: wrap; gap: 10px;
}
.brand h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; color: white; }
.brand span { color: var(--primary); font-weight: 900; }
.brand .subtitle { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

#activeLineLabel {
    display: none;
    margin-top: 5px;
    font-size: 0.9rem;
    color: var(--primary);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.header-actions { display: flex; gap: 15px; align-items: center; }

.date-display {
    text-align: right;
    border-right: 1px solid var(--border);
    padding-right: 15px;
}
.date-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.date-value { font-size: 1rem; font-weight: 700; color: white; }

.help-btn {
    background: transparent; border: 1px solid var(--border); color: var(--text-muted);
    padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
    display: flex; align-items: center; gap: 5px; transition: 0.2s;
}
.help-btn:hover { background: var(--bg-card); color: white; border-color: var(--primary); }

/* --- √öJ ELEMZ√âS GOMB ST√çLUS --- */
.eval-btn {
    background: var(--purple); color: white; border: none;
    padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.85rem;
    display: flex; align-items: center; gap: 8px; box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
    transition: 0.2s;
}
.eval-btn:hover { background: #7c3aed; box-shadow: 0 0 15px rgba(139, 92, 246, 0.6); transform: translateY(-1px); }

/* CONTROLS AREA */
.controls-area {
    display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; flex-wrap: wrap;
}
.upload-btn {
    background: var(--primary); color: white; border: none; padding: 10px 20px;
    border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center;
    white-space: nowrap; height: 42px;
}
.upload-btn:hover { background: #2563eb; }

.filter-bar {
    display: flex; gap: 10px; background: var(--bg-card);
    padding: 10px; border-radius: 8px; border: 1px solid var(--border); flex: 1;
    flex-wrap: wrap;
}
.filter-group { flex: 1; min-width: 140px; }
.filter-group label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 4px; }
select {
    background: var(--bg-app); color: white; border: 1px solid var(--border);
    padding: 6px; border-radius: 4px; font-size: 0.9rem; width: 100%; height: 30px;
}

/* KPI CARDS */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
.kpi-card {
    background: var(--bg-card); padding: 15px; border-radius: 10px;
    border: 1px solid var(--border); position: relative;
    display: flex; flex-direction: column; justify-content: space-between;
}
.kpi-card h3 { margin: 0 0 5px 0; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); }

.kpi-main-val { font-size: 1.8rem; font-weight: 800; display: block; line-height: 1.1; margin-bottom: 4px; }
.kpi-sub-val { font-size: 1rem; font-weight: 600; opacity: 0.9; display: block; }

.kpi-footer { font-size: 0.75rem; margin-top: 10px; font-weight: 500; display: flex; align-items: center; gap: 6px; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px;}
.badge-ppm {
    background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: normal;
}

/* PANELS */
.analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.panel { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
.panel-header {
    padding: 10px 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2);
}
.panel-title { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; margin: 0; display: flex; align-items: center; gap: 8px; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

.alert-banner {
    margin: 10px 10px 0 10px; padding: 8px 12px; border-radius: 6px;
    font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center;
    border-left: 3px solid;
}

/* TABLE */
table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
th { text-align: left; padding: 8px 12px; color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }

.item-name { font-weight: 700; color: #fff; display: block; }
.item-loc { font-size: 0.7rem; color: var(--primary); background: rgba(59, 130, 246, 0.1); padding: 1px 4px; border-radius: 3px; display: inline-block; margin-top: 2px;}
.stat-primary { font-weight: 800; font-size: 0.9rem; text-align: right; }
.stat-secondary { font-size: 0.7rem; color: var(--text-muted); text-align: right; }
.prog-track { width: 100%; height: 3px; background: rgba(255,255,255,0.1); margin-top: 5px; border-radius: 2px; }
.prog-fill { height: 100%; border-radius: 2px; }

/* MODAL (HELP) */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-modal); z-index: 1000; justify-content: center; align-items: center;
    padding: 20px; backdrop-filter: blur(5px);
}
.modal-content {
    background: var(--bg-card); max-width: 600px; width: 100%; border-radius: 12px;
    border: 1px solid var(--border); padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    max-height: 90vh; overflow-y: auto;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
.modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
.help-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.help-section:last-child { border-bottom: none; }
.help-title { color: var(--primary); font-weight: bold; font-size: 1rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.help-text { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; }
.formula { 
    background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; 
    font-family: 'Courier New', monospace; color: #fff; display: block; 
    margin-top: 8px; border: 1px solid var(--border);
}

/* --- √öJ ELEMZ≈ê MODAL ST√çLUSOK (PRO DIAGRAMOK) --- */
.eval-container { max-width: 1000px !important; }
.eval-summary-box {
    background: rgba(139, 92, 246, 0.1); border: 1px solid var(--purple);
    padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;
}
.eval-summary-title { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
.eval-summary-value { font-size: 1.5rem; color: white; font-weight: bold; margin: 5px 0; }
.eval-chart-row {
    display: flex; align-items: center; margin-bottom: 12px; font-size: 0.85rem;
}
.eval-chart-label { width: 180px; text-align: right; padding-right: 15px; font-weight: bold; color: #cbd5e1; }
.eval-chart-area { flex: 1; height: 24px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; display: flex; position: relative; }
.eval-bar-pick { height: 100%; background: var(--danger); transition: width 1s; }
.eval-bar-vis { height: 100%; background: var(--warning); transition: width 1s; }
.eval-chart-value { width: 80px; padding-left: 10px; font-weight: bold; color: white; }
.chart-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 0.8rem; }
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-box { width: 12px; height: 12px; border-radius: 2px; }

/* UTILS */
.text-danger { color: var(--danger); }
.text-warning { color: var(--warning); }
.text-success { color: var(--success); }
.bg-danger-sub { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: var(--danger); }
.bg-warning-sub { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-color: var(--warning); }

/* --- RESPONSIVE --- */
@media (max-width: 768px) {
    body { padding: 10px; }
    .header-actions { width: 100%; justify-content: space-between; margin-top: 10px; }
    .date-display { border-right: none; padding-right: 0; }
    .controls-area { flex-direction: column; }
    .upload-btn { width: 100%; justify-content: center; }
    .filter-bar { width: 100%; flex-direction: column; }
    .kpi-grid { grid-template-columns: 1fr 1fr; } 
    .analysis-grid { grid-template-columns: 1fr; }
    .eval-chart-label { width: 100px; font-size: 0.7rem; }
}

/* --- EREDETI NYOMTAT√ÅSI K√ìD VISSZA√ÅLL√çTVA --- */
@media print {
    @page { size: A4 portrait; margin: 10mm 5mm 5mm 5mm; }
    
    /* Az √∫j gombot elrejtj√ºk nyomtat√°skor */
    .eval-btn { display: none !important; }

    body { 
        background: white !important; color: black !important; padding: 0 !important; 
        zoom: 75% !important;
        -webkit-print-color-adjust: exact !important;
    }
    
    .container { max-width: 100% !important; margin: 0 !important; }
    .controls-area, .help-btn, .modal-overlay { display: none !important; }

    /* FEJL√âC PROFESSZION√ÅLIS IGAZ√çT√ÅSA (K√ñZ√âPRE) */
    header {
        display: block !important;
        text-align: center !important;
        margin-bottom: 30px !important;
        border-bottom: 2px solid #333 !important;
        padding-bottom: 15px !important;
    }

    .brand {
        display: block !important;
        margin-bottom: 10px !important;
    }
    .brand h1 {
        font-size: 24px !important;
        color: #000 !important;
        letter-spacing: 2px !important;
    }
    .brand .subtitle {
        color: #555 !important;
        font-size: 10px !important;
    }
    
    /* AKT√çV SOR NYOMTAT√ÅSI ST√çLUS */
    #activeLineLabel {
        color: #000 !important;
        font-size: 14px !important;
        margin-top: 8px !important;
        border: 1px solid #000;
        padding: 4px 10px;
        display: inline-block !important;
    }

    .header-actions {
        display: block !important;
        text-align: center !important;
        width: 100% !important;
        margin-top: 10px !important;
    }

    .date-display {
        border-right: none !important;
        padding-right: 0 !important;
        text-align: center !important;
    }
    .date-label { color: #555 !important; font-size: 10px !important; }
    .date-value { color: #000 !important; font-size: 14px !important; margin-top: 2px !important; }

    /* T√ñBBI NYOMTAT√ÅSI BE√ÅLL√çT√ÅS */
    .kpi-card, .panel { 
        background: white !important; border: 1px solid #ccc !important; 
        box-shadow: none !important; break-inside: avoid; 
    }
    .panel-header { background: #f0f0f0 !important; border-bottom: 1px solid #ccc !important; }
    .item-name { color: #000 !important; }
    td { border-bottom: 1px solid #eee !important; }
    .item-loc { background: #eff6ff !important; color: #1d4ed8 !important; border: 1px solid #bfdbfe !important; }
    .text-danger { color: #dc2626 !important; }
    .text-warning { color: #d97706 !important; }
    .text-success { color: #059669 !important; }
    .bg-danger-sub { background: #fef2f2 !important; border-color: #dc2626 !important; color: #991b1b !important; }
    .bg-warning-sub { background: #fffbeb !important; border-color: #d97706 !important; color: #92400e !important; }
    .kpi-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 10px !important; }
    .analysis-grid { grid-template-columns: 1fr 1fr !important; gap: 15px !important; }
    .kpi-main-val { font-size: 1.6rem !important; }
    .kpi-footer { border-top: 1px solid #eee !important; color: #555 !important; }
    .badge-ppm { border: 1px solid #ddd !important; background: #fff !important; }
}
</style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <h1>Forvia <span>SMT Analytics</span></h1>
            <div class="subtitle">Production Quality & Attrition Dashboard by: Fajcsik Val√©r 2026</div>
            <div id="activeLineLabel"></div>
        </div>
        <div class="header-actions">
            <button class="eval-btn" onclick="generateEvaluation()">
                üìä R√âSZLETES KI√âRT√âKEL√âS
            </button>
            <div class="date-display">
                <div class="date-label">Elemzett Id≈ëszak</div>
                <div class="date-value" id="reportDate">MAI NAP</div>
            </div>
            <button class="help-btn" onclick="toggleModal('helpModal', true)">‚ùì MAGYAR√ÅZAT</button>
        </div>
    </header>

    <div class="controls-area">
        <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
            üìÇ Adatf√°jl (CSV)
        </div>
        <input type="file" id="fileInput" accept=".csv,.txt" style="display:none">

        <div class="filter-bar">
            <div class="filter-group">
                <label>G√©psor</label>
                <select id="filterLine" onchange="filterLineChanged()"><option value="mind">Teljes Gy√°r</option></select>
            </div>
            <div class="filter-group">
                <label>Be√ºltet≈ë G√©p</label>
                <select id="filterMachine" onchange="updateView()"><option value="mind">Minden G√©p</option></select>
            </div>
            <div class="filter-group">
                <label>Toplista M√©ret</label>
                <select id="topLimit" onchange="updateView()">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="15">Top 15</option>
                </select>
            </div>
        </div>
        <button onclick="window.print()" style="background:#334155; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">üñ®Ô∏è PDF</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card" style="border-top: 4px solid var(--primary);">
            <h3>Gy√°rtott Mennyis√©g</h3>
            <div><span class="kpi-main-val" id="kpiTotal">0</span></div>
            <div class="kpi-footer">Be√ºltetett (J√≥) darab</div>
        </div>
        <div class="kpi-card" style="border-top: 4px solid var(--success);">
            <h3>FPY / Kihozatal</h3>
            <div><span class="kpi-main-val text-success" id="kpiYield">100%</span></div>
            <div class="kpi-footer">First Pass Yield</div>
        </div>
        <div class="kpi-card" style="border-top: 4px solid var(--danger);">
            <h3>Felv√©teli Hiba (Pick)</h3>
            <div>
                <span class="kpi-main-val text-danger" id="kpiPickCount">0 db</span>
                <span class="kpi-sub-val text-danger" id="kpiPickRate">0.00%</span>
            </div>
            <div class="kpi-footer"><span id="kpiPickPPM" class="badge-ppm">0 PPM</span><span>vesztes√©g</span></div>
        </div>
        <div class="kpi-card" style="border-top: 4px solid var(--warning);">
            <h3>Felismer√©si Hiba (Vision)</h3>
            <div>
                <span class="kpi-main-val text-warning" id="kpiVisCount">0 db</span>
                <span class="kpi-sub-val text-warning" id="kpiVisRate">0.00%</span>
            </div>
            <div class="kpi-footer"><span id="kpiVisPPM" class="badge-ppm">0 PPM</span><span>vesztes√©g</span></div>
        </div>
    </div>

    <div class="analysis-grid">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title text-danger"><span class="dot" style="background:var(--danger)"></span> KRITIKUS FELV√âTELI HIB√ÅK</h3>
            </div>
            <div id="alertPick" class="alert-banner bg-danger-sub" style="display:none"></div>
            <table id="tablePick">
                <thead><tr><th>Cikksz√°m</th><th style="text-align:right">Elsz√≥r√≥d√°s / R√©szar√°ny</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title text-warning"><span class="dot" style="background:var(--warning)"></span> KRITIKUS FELISMER√âSI HIB√ÅK</h3>
            </div>
            <div id="alertVis" class="alert-banner bg-warning-sub" style="display:none"></div>
            <table id="tableVis">
                <thead><tr><th>Cikksz√°m</th><th style="text-align:right">Elsz√≥r√≥d√°s / R√©szar√°ny</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="helpModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('helpModal', false)">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0">Forvia Analytics - Szakmai √ötmutat√≥</h2>
            <button class="modal-close" onclick="toggleModal('helpModal', false)">&times;</button>
        </div>
        <div class="help-section">
            <div class="help-title">1. A Sz√°m√≠t√°s M√≥dszertana</div>
            <div class="help-text">Ez a dashboard a val√≥s anyagvesztes√©get (Scrap Rate) mutatja a teljes bet√°razott mennyis√©ghez viszony√≠tva.</div>
        </div>
        <div class="help-section">
            <div class="help-title">2. KPI Mutat√≥k</div>
            <div class="help-text">FPY, PPM √©s Hibaar√°nyok r√©szletes elemz√©se a gy√°rt√°si folyamatban.</div>
        </div>
        <button onclick="toggleModal('helpModal', false)" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">BEZ√ÅR√ÅS</button>
    </div>
</div>

<div id="evalModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('evalModal', false)">
    <div class="modal-content eval-container">
        <div class="modal-header">
            <h2 style="margin:0; color:var(--purple);">üìä G√âPEK √âS TELJES√çTM√âNY ELEMZ√âS</h2>
            <button class="modal-close" onclick="toggleModal('evalModal', false)">&times;</button>
        </div>
        
        <div class="eval-summary-box">
            <div class="eval-summary-title">FIGYELEM: A LEGGYENG√âBBEN TELJES√çT≈ê G√âP</div>
            <div class="eval-summary-value" id="evalWorstMachine">-</div>
            <div style="font-size:0.9rem; color:#cbd5e1" id="evalWorstReason">-</div>
        </div>

        <div class="chart-legend">
            <div class="legend-item"><div class="legend-box" style="background:var(--danger)"></div> Pick (Felv√©tel)</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--warning)"></div> Vision (Kamera)</div>
        </div>

        <div class="help-title">G√âPEK RANGSORA (HIBA DB SZERINT CS√ñKKEN≈ê)</div>
        <div id="machineChartContainer" style="margin-bottom: 30px; max-height:400px; overflow-y:auto; padding-right:10px;">
            </div>

        <div class="help-title">JAVASOLT INT√âZKED√âSI TERV</div>
        <div class="help-text" id="evalActionPlan">
            Az adatok bet√∂lt√©se ut√°n itt jelenik meg a javaslat.
        </div>

        <button onclick="toggleModal('evalModal', false)" style="width:100%; padding:12px; background:var(--purple); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:20px;">VISSZA A F≈êOLDALRA</button>
    </div>
</div>

<script>
let rawData = [];
let lineMachineMap = {}; 
document.getElementById('reportDate').innerText = new Date().toLocaleDateString('hu-HU');

// M√≥dos√≠tott modal kezel≈ë, hogy t√∂bb ablakot kezeljen
function toggleModal(id, show) { 
    document.getElementById(id).style.display = show ? 'flex' : 'none'; 
}

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const fileName = file.name;
    const dateMatch = fileName.match(/\((.*?)\)/); 
    if(dateMatch && dateMatch[1]) {
        document.getElementById('reportDate').innerText = dateMatch[1];
        document.getElementById('reportDate').style.color = "var(--primary)";
    }
    const reader = new FileReader();
    reader.onload = (ev) => processData(ev.target.result);
    reader.readAsText(file);
});

function processData(csvText) {
    const lines = csvText.split('\n').map(x => x.trim()).filter(x => x);
    if(lines.length < 2) return;
    const sep = lines[0].indexOf(';') > -1 ? ';' : ',';
    rawData = []; lineMachineMap = {};
    for(let i=1; i<lines.length; i++) {
        const col = lines[i].split(sep);
        if(col.length < 4) continue;
        const line = col[0] ? col[0].trim() : "Egy√©b";
        const machine = col[1] ? col[1].trim() : "Egy√©b";
        if(!lineMachineMap[line]) lineMachineMap[line] = new Set();
        lineMachineMap[line].add(machine);
        rawData.push({
            line: line, machine: machine, part: col[2] ? col[2].trim() : "Unknown",
            good: parseInt(col[3]) || 0,
            pickErr: parseInt(col[4]) || 0,
            visErr: parseInt(col[5]) || 0
        });
    }
    initFilters();
    updateView();
}

function initFilters() {
    const s = document.getElementById('filterLine');
    s.innerHTML = '<option value="mind">Teljes Gy√°r</option>';
    Object.keys(lineMachineMap).sort().forEach(l => s.innerHTML += `<option value="${l}">${l}</option>`);
    filterLineChanged(); 
}

function filterLineChanged() {
    const sLine = document.getElementById('filterLine').value;
    const mSelect = document.getElementById('filterMachine');
    mSelect.innerHTML = '<option value="mind">Minden G√©p</option>';
    if (sLine !== 'mind' && lineMachineMap[sLine]) {
        Array.from(lineMachineMap[sLine]).sort().forEach(m => mSelect.innerHTML += `<option value="${m}">${m}</option>`);
    } else {
        const allM = new Set();
        Object.values(lineMachineMap).forEach(s => s.forEach(m => allM.add(m)));
        Array.from(allM).sort().forEach(m => mSelect.innerHTML += `<option value="${m}">${m}</option>`);
    }
    updateView();
}

function updateView() {
    if(rawData.length === 0) return;
    const sLine = document.getElementById('filterLine').value;
    const sMach = document.getElementById('filterMachine').value;
    const limit = parseInt(document.getElementById('topLimit').value);
    
    const lineLabel = document.getElementById('activeLineLabel');
    if(sLine !== 'mind') {
        lineLabel.innerText = "Kiv√°lasztott Sor: " + sLine;
        lineLabel.style.display = 'block';
    } else {
        lineLabel.style.display = 'none';
    }

    const data = rawData.filter(d => (sLine === 'mind' || d.line === sLine) && (sMach === 'mind' || d.machine === sMach));

    let sumGood=0, sumPick=0, sumVis=0;
    let pMap={}, vMap={}, lMap={};

    data.forEach(d => {
        sumGood += d.good; sumPick += d.pickErr; sumVis += d.visErr;
        if(d.pickErr > 0) pMap[d.part] = (pMap[d.part]||0) + d.pickErr;
        if(d.visErr > 0) vMap[d.part] = (vMap[d.part]||0) + d.visErr;
        if(d.pickErr > 0 || d.visErr > 0) {
            if(!lMap[d.part]) lMap[d.part] = new Set();
            lMap[d.part].add(`${d.machine}`);
        }
    });

    const totalUsage = sumGood + sumPick + sumVis;
    const pickRate = totalUsage > 0 ? (sumPick/totalUsage)*100 : 0;
    const visRate = totalUsage > 0 ? (sumVis/totalUsage)*100 : 0;
    const pickPPM = totalUsage > 0 ? Math.round((sumPick/totalUsage)*1000000) : 0;
    const visPPM = totalUsage > 0 ? Math.round((sumVis/totalUsage)*1000000) : 0;
    const yieldVal = totalUsage > 0 ? (sumGood/totalUsage)*100 : 100;

    document.getElementById('kpiTotal').innerText = sumGood.toLocaleString();
    const yieldEl = document.getElementById('kpiYield');
    yieldEl.innerText = yieldVal.toFixed(2) + "%";
    
    if (yieldVal < 99.98) {
        yieldEl.classList.remove('text-success'); yieldEl.classList.add('text-danger');
    } else {
        yieldEl.classList.remove('text-danger'); yieldEl.classList.add('text-success');
    }
    
    document.getElementById('kpiPickCount').innerText = sumPick.toLocaleString() + " db";
    document.getElementById('kpiPickRate').innerText = pickRate.toFixed(2) + "%";
    document.getElementById('kpiPickPPM').innerText = pickPPM.toLocaleString() + " PPM";
    
    document.getElementById('kpiVisCount').innerText = sumVis.toLocaleString() + " db";
    document.getElementById('kpiVisRate').innerText = visRate.toFixed(2) + "%";
    document.getElementById('kpiVisPPM').innerText = visPPM.toLocaleString() + " PPM";

    renderTable('tablePick', pMap, lMap, sumPick, limit, 'alertPick', 'text-danger', 'var(--danger)');
    renderTable('tableVis', vMap, lMap, sumVis, limit, 'alertVis', 'text-warning', 'var(--warning)');
}

function renderTable(tid, dMap, lMap, total, limit, aid, tCls, col) {
    const tbody = document.getElementById(tid).querySelector('tbody');
    tbody.innerHTML = "";
    const sorted = Object.entries(dMap).sort((a,b) => b[1]-a[1]);
    const aEl = document.getElementById(aid);
    if(sorted.length > 0) {
        const share = total>0 ? ((sorted[0][1]/total)*100).toFixed(1) : 0;
        aEl.style.display = "flex";
        aEl.innerHTML = `<span><strong>TOP HIBA:</strong> ${sorted[0][0]}</span><span>A hib√°k <strong>${share}%</strong>-a!</span>`;
    } else { aEl.style.display = "none"; }
    const maxVal = sorted.length > 0 ? sorted[0][1] : 1;
    sorted.slice(0, limit).forEach((it, i) => {
        const locs = Array.from(lMap[it[0]]||["-"]);
        let lStr = locs.slice(0,2).join(", ");
        if(locs.length>2) lStr += ` (+${locs.length-2})`;
        const share = total>0 ? ((it[1]/total)*100).toFixed(1) : "0.0";
        tbody.innerHTML += `
        <tr>
            <td>
                <span class="item-name">${i+1}. ${it[0]}</span>
                <span class="item-loc">${lStr}</span>
                <div class="prog-track"><div class="prog-fill" style="width:${(it[1]/maxVal)*100}%; background:${col}"></div></div>
            </td>
            <td style="vertical-align:top">
                <div class="stat-primary ${tCls}">${it[1].toLocaleString()}</div>
                <div class="stat-secondary">${share}% r√©szar√°ny</div>
            </td>
        </tr>`;
    });
}

// --- √öJ FUNKCI√ì: R√âSZLETES KI√âRT√âKEL√âS GENER√ÅL√ÅSA ---
function generateEvaluation() {
    if(rawData.length === 0) { alert("K√©rlek t√∂lts be egy f√°jlt el≈ësz√∂r!"); return; }

    const sLine = document.getElementById('filterLine').value;
    const chartContainer = document.getElementById('machineChartContainer');
    chartContainer.innerHTML = "";

    // 1. Adatok √∂sszegz√©se g√©penk√©nt
    let machStats = {};
    rawData.forEach(d => {
        // Ha van sz≈±r√©s, csak azokat vegy√ºk figyelembe
        if(sLine !== 'mind' && d.line !== sLine) return;

        let key = d.machine;
        // Ha t√∂bb sor van, tegy√ºk el√© a sor nev√©t
        if(sLine === 'mind') key = d.line + " - " + d.machine;

        if(!machStats[key]) machStats[key] = { p:0, v:0, total:0 };
        machStats[key].p += d.pickErr;
        machStats[key].v += d.visErr;
        machStats[key].total += (d.pickErr + d.visErr);
    });

    // 2. Rendez√©s (Legrosszabb el≈ël)
    let sortedMach = Object.entries(machStats).sort((a,b) => b[1].total - a[1].total);
    
    if(sortedMach.length === 0) { alert("Nincs megjelen√≠thet≈ë adat a sz≈±r√©s alapj√°n."); return; }

    // 3. Legrosszabb g√©p kiemel√©se
    const worst = sortedMach[0];
    const worstTotal = worst[1].total;
    const worstName = worst[0];
    const pPerc = worstTotal > 0 ? Math.round((worst[1].p / worstTotal)*100) : 0;
    
    document.getElementById('evalWorstMachine').innerText = worstName;
    document.getElementById('evalWorstReason').innerText = 
        `${worstTotal} db hiba (${pPerc}% Felv√©teli, ${100-pPerc}% Vision)`;

    // 4. Javaslat gener√°l√°sa
    const actionDiv = document.getElementById('evalActionPlan');
    let actionHTML = "<ul>";
    actionHTML += `<li><strong style='color:var(--danger)'>S√ºrg≈ës beavatkoz√°s:</strong> A <strong>${worstName}</strong> g√©p felel≈ës a jelenlegi hib√°k jelent≈ës r√©sz√©√©rt.</li>`;
    
    if(worst[1].p > worst[1].v) {
        actionHTML += `<li><strong>Hiba jellege:</strong> T√∫lnyom√≥r√©szt <span style='color:var(--danger)'>PICK (Felv√©teli)</span> hiba. Ellen≈ërizd a Feedereket, Nozzle-√∂ket √©s a V√°kuum szintet ezen a g√©pen!</li>`;
    } else {
        actionHTML += `<li><strong>Hiba jellege:</strong> T√∫lnyom√≥r√©szt <span style='color:var(--warning)'>VISION (Kamera)</span> hiba. Ellen≈ërizd a kamer√°k tisztas√°g√°t √©s az alkatr√©sz defin√≠ci√≥kat!</li>`;
    }
    actionHTML += "</ul>";
    actionDiv.innerHTML = actionHTML;

    // 5. Diagramok kirajzol√°sa (Max √©rt√©khez viszony√≠tva)
    const maxVal = worstTotal > 0 ? worstTotal : 1;

    sortedMach.forEach(m => {
        const mName = m[0];
        const pVal = m[1].p;
        const vVal = m[1].v;
        const tot = m[1].total;
        
        // Sz√°zal√©kos sz√©less√©g a diagramon (a legrosszabbhoz k√©pest)
        const totalWidthPercent = (tot / maxVal) * 100;
        // Bels≈ë ar√°nyok (Pick vs Vision)
        const pShare = tot > 0 ? (pVal / tot) * 100 : 0;
        const vShare = tot > 0 ? (vVal / tot) * 100 : 0;

        const html = `
        <div class="eval-chart-row">
            <div class="eval-chart-label">${mName}</div>
            <div class="eval-chart-area" style="width: ${totalWidthPercent}%">
                <div class="eval-bar-pick" style="width:${pShare}%"></div>
                <div class="eval-bar-vis" style="width:${vShare}%"></div>
            </div>
            <div class="eval-chart-value">${tot} db</div>
        </div>`;
        chartContainer.innerHTML += html;
    });

    toggleModal('evalModal', true);
}
</script>
</body>
</html>
