<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORVIA | Staff Pro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0b0f1a; 
            color: #e2e8f0; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        header { flex: none; background: linear-gradient(to bottom, #111827, #0f172a); border-bottom: 1px solid #1e293b; z-index: 60; }
        main { flex-grow: 1; position: relative; overflow: hidden; background: #111827; }
        footer { flex: none; background: #0f172a; border-top: 1px solid #1e293b; padding: 8px; z-index: 60; }

        .table-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: auto; -webkit-overflow-scrolling: touch; }
        .matrix-table { border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        
        .matrix-table thead th {
            position: sticky; top: 0; z-index: 30; background: #1e293b; height: 40px; 
            box-shadow: 0 1px 0 #2d3748; padding: 2px 0; width: 36px; min-width: 36px; box-sizing: border-box;
        }

        .name-col { 
            position: sticky !important; left: 0 !important; z-index: 40 !important;
            width: 140px !important; min-width: 140px !important; max-width: 140px !important;
            background: #1e293b !important; border-right: 2px solid #3b82f6 !important; 
            padding: 0 4px !important; box-shadow: 4px 0 8px rgba(0,0,0,0.3);
            white-space: normal !important; word-wrap: break-word !important; line-height: 1.1 !important;
        }

        .sticky-quota { position: sticky !important; left: 140px !important; width: 60px !important; min-width: 60px !important; z-index: 40 !important; background: #1e293b !important; border-right: 1px solid #334155 !important; }
        .sticky-rem { position: sticky !important; left: 200px !important; width: 60px !important; min-width: 60px !important; z-index: 40 !important; background: #1e293b !important; border-right: 4px solid #0f172a !important; box-shadow: 6px 0 10px rgba(0,0,0,0.4); }

        .matrix-table thead th.name-col, .matrix-table thead th.sticky-quota, .matrix-table thead th.sticky-rem { z-index: 50 !important; background: #1e293b; }

        tr.row-highlight .name-col { background-color: #3b82f6 !important; color: white !important; }
        .row-highlight { background: rgba(59, 130, 246, 0.15) !important; } 
        .col-highlight { background: rgba(59, 130, 246, 0.15) !important; }
        .weekend { background: #141b2d !important; color: #64748b; }
        .matrix-table th, .matrix-table td { border: 1px solid #2d3748; height: 40px; text-align: center; font-size: 13px; padding: 0; }

        .input-cell { width: 100%; height: 100%; border: none; text-align: center; background: transparent; color: white; font-weight: 700; outline: none; font-size: 16px; }
        .input-cell:focus { background: rgba(59, 130, 246, 0.3); }

        .cell-S { background: #059669 !important; }
        .cell-BA { background: #ea580c !important; }
        .cell-IG { background: #7c3aed !important; }
        .cell-TU { background: #2563eb !important; }
        .cell-KE { background: #d97706 !important; }

        .shift-btn { transition: all 0.3s; border: 1px solid #334155; }
        .shift-btn.active { transform: scale(1.05); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .shift-A.active { background: #ef4444; border-color: #f87171; }
        .shift-B.active { background: #10b981; border-color: #34d399; }
        .shift-C.active { background: #f59e0b; border-color: #fbbf24; }
        .shift-D.active { background: #8b5cf6; border-color: #a78bfa; }

        .today-base { font-weight: 900 !important; }
        .today-A { border-left: 2px solid #ef4444 !important; border-right: 2px solid #ef4444 !important; }
        .today-B { border-left: 2px solid #10b981 !important; border-right: 2px solid #10b981 !important; }
        .today-C { border-left: 2px solid #f59e0b !important; border-right: 2px solid #f59e0b !important; }
        .today-D { border-left: 2px solid #8b5cf6 !important; border-right: 2px solid #8b5cf6 !important; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <header class="p-2 no-print shadow-xl flex flex-col gap-2">
        <div class="flex justify-between items-center w-full">
            <div class="flex flex-col">
                <span class="text-blue-500 font-black text-xl tracking-tighter leading-none">FORVIA</span>
                <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Staff Pro 2026</span>
            </div>
            <div class="flex gap-1">
                <button onclick="changeShift('A')" id="btn-shift-A" class="shift-btn shift-A px-3 py-1.5 rounded text-[10px] font-black uppercase">A</button>
                <button onclick="changeShift('B')" id="btn-shift-B" class="shift-btn shift-B px-3 py-1.5 rounded text-[10px] font-black uppercase">B</button>
                <button onclick="changeShift('C')" id="btn-shift-C" class="shift-btn shift-C px-3 py-1.5 rounded text-[10px] font-black uppercase">C</button>
                <button onclick="changeShift('D')" id="btn-shift-D" class="shift-btn shift-D px-3 py-1.5 rounded text-[10px] font-black uppercase">D</button>
            </div>
        </div>

        <div class="flex items-center justify-between w-full gap-2 overflow-x-auto pb-1">
            <div id="sync" class="bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded-full text-[9px] font-black border border-emerald-500/20 whitespace-nowrap">ONLINE</div>
            <div class="flex items-center bg-slate-900/80 border border-slate-700/50 rounded-lg p-0.5">
                <button onclick="changeMonth(-1)" class="p-2 text-blue-400"><i class="fas fa-chevron-left text-xs"></i></button>
                <span id="monthDisp" class="font-black text-xs uppercase w-20 text-center text-blue-400 tracking-widest">Jan</span>
                <button onclick="changeMonth(1)" class="p-2 text-blue-400"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
            <button onclick="jumpToToday()" class="bg-slate-800 text-blue-400 border border-blue-500/30 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase">MA</button>
            <div class="flex bg-slate-900/80 p-0.5 rounded-lg border border-slate-700/50 ml-auto">
                <button onclick="setView('matrix')" id="nav-m" class="px-3 py-1.5 rounded text-[10px] font-black uppercase"><i class="fas fa-table"></i></button>
                <button onclick="setView('stats')" id="nav-s" class="px-3 py-1.5 rounded text-[10px] font-black uppercase ml-1"><i class="fas fa-id-card"></i></button>
            </div>
            <div class="flex gap-1">
                <button onclick="backupAllData()" class="bg-violet-600 px-3 py-1.5 rounded-lg text-white"><i class="fas fa-download"></i></button>
                <button onclick="addEmp()" class="bg-blue-600 px-3 py-1.5 rounded-lg text-white"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </header>

    <main class="no-print">
        <div id="v-matrix" class="w-full h-full">
            <div class="table-container">
                <table class="matrix-table" id="mainTable">
                    <thead id="tHead"></thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
        <div id="v-stats" class="hidden absolute inset-0 overflow-y-auto p-4 bg-[#0b0f1a]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-blue-500 uppercase">Éves Statisztika</h2>
                <button onclick="printStats()" class="bg-white text-black px-4 py-2 rounded-lg font-black text-xs uppercase flex items-center gap-2">
                    <i class="fas fa-print"></i> Nyomtatás
                </button>
            </div>
            <div id="stats-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10"></div>
        </div>
    </main>

    <footer class="no-print">
        <div class="grid grid-cols-5 gap-1">
            <div class="flex flex-col items-center p-1 rounded bg-slate-800/50 border border-slate-700"><div class="w-2 h-2 rounded-full cell-S mb-1"></div><span class="text-[7px] font-bold text-slate-400 uppercase">Szabi</span></div>
            <div class="flex flex-col items-center p-1 rounded bg-slate-800/50 border border-slate-700"><div class="w-2 h-2 rounded-full cell-BA mb-1"></div><span class="text-[7px] font-bold text-slate-400 uppercase">Beteg</span></div>
            <div class="flex flex-col items-center p-1 rounded bg-slate-800/50 border border-slate-700"><div class="w-2 h-2 rounded-full cell-IG mb-1"></div><span class="text-[7px] font-bold text-slate-400 uppercase">Igazolatlan</span></div>
            <div class="flex flex-col items-center p-1 rounded bg-slate-800/50 border border-slate-700"><div class="w-2 h-2 rounded-full cell-TU mb-1"></div><span class="text-[7px] font-bold text-slate-400 uppercase">Túlóra</span></div>
            <div class="flex flex-col items-center p-1 rounded bg-slate-800/50 border border-slate-700"><div class="w-2 h-2 rounded-full cell-KE mb-1"></div><span class="text-[7px] font-bold text-slate-400 uppercase">Késés</span></div>
        </div>
    </footer>

    <script>
        let currentShift = localStorage.getItem('fv_shift_final') || 'A';
        const DB = "https://forviastaff-default-rtdb.firebaseio.com/";
        let date = new Date(2026, 0, 1);
        let employees = [];
        const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
        const dayNamesShort = ["V", "H", "K", "Sze", "Cs", "P", "Szo"];
        const holidays2026 = ["1-1", "3-15", "4-3", "4-6", "5-1", "5-25", "8-20", "10-23", "11-1", "12-25", "12-26"];

        async function changeShift(s) {
            currentShift = s; localStorage.setItem('fv_shift_final', s);
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-shift-${s}`).classList.add('active');
            await load();
        }

        async function load() {
            try {
                const res = await fetch(`${DB}shift_${currentShift}.json`);
                const data = await res.json();
                employees = Array.isArray(data) ? data : [];
                render(); initSortable();
            } catch(e) { console.error("Load hiba"); }
        }

        async function save() {
            document.getElementById('sync').innerHTML = '<i class="fas fa-spin fa-sync"></i>';
            try {
                await fetch(`${DB}shift_${currentShift}.json`, { method: 'PUT', body: JSON.stringify(employees) });
                document.getElementById('sync').innerHTML = 'ONLINE';
            } catch(e) { document.getElementById('sync').innerText = "HIBA!"; }
        }

        function render() {
            const m = date.getMonth(); const days = new Date(2026, m+1, 0).getDate();
            document.getElementById('monthDisp').innerText = monthNames[m];
            const today = new Date(); const isCurr = today.getFullYear() === 2026 && today.getMonth() === m; const curD = today.getDate();

            let h = `<tr><th class="name-col">Név</th><th class="sticky-quota bg-slate-800">KERET</th><th class="sticky-rem bg-slate-800">KIVEHETŐ</th>`;
            for(let d=1; d<=days; d++) {
                const isHol = holidays2026.includes(`${m+1}-${d}`); const isT = isCurr && d === curD;
                h += `<th id="${isT?'today-header':''}" class="${isHol?'holiday-text':''} ${isT?`today-base today-${currentShift}`:''}">${d}<br><span class="text-[8px] font-normal opacity-50">${dayNamesShort[new Date(2026, m, d).getDay()]}</span></th>`;
            }
            document.getElementById('tHead').innerHTML = h + "</tr>";

            document.getElementById('tBody').innerHTML = employees.map(e => {
                let s = 0; if(e.data) Object.values(e.data).forEach(v => { let n=parseFloat(String(v).replace(',','.')); if(!isNaN(n)) s+=n; });
                let row = `<tr data-id="${e.id}"><td class="name-col"><div class="flex justify-between items-center w-full"><span class="font-black text-[11px] uppercase">${e.name}</span><button onclick="delEmp(${e.id})" class="text-red-500/30 p-1"><i class="fas fa-times"></i></button></div></td>
                <td class="sticky-quota bg-slate-800"><input type="number" value="${e.yearlyQuota||160}" onchange="employees.find(x=>x.id==${e.id}).yearlyQuota=this.value; save(); render();" class="input-cell text-blue-300"></td>
                <td id="rem-${e.id}" class="sticky-rem bg-slate-800 text-emerald-400 font-black text-[15px]">${(e.yearlyQuota||160)-s}</td>`;
                for(let d=1; d<=days; d++) {
                    const k = `2026-${m+1}-${d}`, v = (e.data && e.data[k]) ? e.data[k] : "";
                    const isW = [0,6].includes(new Date(2026,m,d).getDay()); const isH = holidays2026.includes(`${m+1}-${d}`); const isT = isCurr && d === curD;
                    const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : (v==='BÁ'?'cell-BA':v==='IG'?'cell-IG':v==='TU'?'cell-TU':v.startsWith('KÉ')?'cell-KE':'');
                    row += `<td class="${isW||isH?'weekend':''} ${isH?'holiday-bg':''} ${cls} ${isT?`today-base today-${currentShift}`:''}"><input type="text" value="${v}" onfocus="this.select(); highlight(this,${d},true)" onblur="highlight(this,${d},false); update(${e.id},'${k}',this.value,this)" class="input-cell"></td>`;
                }
                return row + "</tr>";
            }).join('');
        }

        function setView(v) {
            document.getElementById('v-matrix').classList.toggle('hidden', v !== 'matrix');
            document.getElementById('v-stats').classList.toggle('hidden', v !== 'stats');
            
            document.getElementById('nav-m').className = v === 'matrix' ? 'px-3 py-1.5 rounded text-[10px] font-black uppercase bg-blue-600 text-white' : 'px-3 py-1.5 rounded text-[10px] font-black uppercase text-slate-400';
            document.getElementById('nav-s').className = v === 'stats' ? 'px-3 py-1.5 rounded text-[10px] font-black uppercase bg-blue-600 text-white' : 'px-3 py-1.5 rounded text-[10px] font-black uppercase text-slate-400';

            if(v==='stats') {
                document.getElementById('stats-grid').innerHTML = employees.map(e => {
                    let t = { S:0, BA:0, IG:0, TU:0, KE:0 };
                    if(e.data) Object.values(e.data).forEach(val => {
                        let n = parseFloat(String(val).replace(',','.'));
                        if(!isNaN(n)) t.S += n; else if(val==='BÁ') t.BA++; else if(val==='IG') t.IG++; else if(val==='TU') t.TU++; else if(String(val).startsWith('KÉ')) t.KE++;
                    });
                    return `<div class="bg-slate-900/80 rounded-2xl p-6 border border-slate-800 shadow-lg"><h3 class="font-black text-white uppercase mb-4 border-b border-slate-800 pb-2">${e.name}</h3><div class="flex justify-between mb-4"><span class="text-slate-400 text-xs uppercase font-bold">Maradék keret</span><span class="text-2xl font-black text-emerald-400">${(e.yearlyQuota||160)-t.S}</span></div><div class="grid grid-cols-2 gap-2"><div class="bg-slate-800/50 p-2 rounded-lg flex justify-between"><span class="text-[10px] text-slate-400 font-bold uppercase">Szabi</span><span class="font-bold">${t.S}</span></div><div class="bg-slate-800/50 p-2 rounded-lg flex justify-between"><span class="text-[10px] text-orange-400 font-bold uppercase">Beteg</span><span class="font-bold">${t.BA}</span></div><div class="bg-slate-800/50 p-2 rounded-lg flex justify-between"><span class="text-[10px] text-purple-400 font-bold uppercase">Túlóra</span><span class="font-bold">${t.TU}</span></div><div class="bg-slate-800/50 p-2 rounded-lg flex justify-between"><span class="text-[10px] text-red-400 font-bold uppercase">Igazolatlan</span><span class="font-bold">${t.IG}</span></div></div></div>`;
                }).join('');
            }
        }

        function printStats() {
            let win = window.open('', '_blank');
            let content = `<html><head><title>FORVIA - Statisztika 2026</title><style>body{font-family:sans-serif;padding:20px;}h1{text-align:center;text-transform:uppercase;font-size:18px;border-bottom:2px solid black;}table{width:100%;border-collapse:collapse;margin-top:20px;}th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:12px;}th{background:#f0f0f0;text-transform:uppercase;font-size:10px;}.val{font-weight:bold;text-align:right;}</style></head><body><h1>FORVIA STAFF PRO - ${currentShift} MŰSZAK (2026)</h1><table><thead><tr><th>Név</th><th>Keret</th><th>Kivett</th><th>Maradék</th><th>Beteg</th><th>Igazolatlan</th><th>Túlóra</th></tr></thead><tbody>`;
            employees.forEach(e => {
                let t = { S:0, BA:0, IG:0, TU:0 };
                if(e.data) Object.values(e.data).forEach(v => { let n=parseFloat(String(v).replace(',','.')); if(!isNaN(n)) t.S+=n; else if(v==='BÁ') t.BA++; else if(v==='IG') t.IG++; else if(v==='TU') t.TU++; });
                content += `<tr><td><b>${e.name}</b></td><td class="val">${e.yearlyQuota||160}</td><td class="val">${t.S}</td><td class="val" style="color:green">${(e.yearlyQuota||160)-t.S}</td><td class="val">${t.BA}</td><td class="val">${t.IG}</td><td class="val">${t.TU}</td></tr>`;
            });
            content += `</tbody></table></body></html>`;
            win.document.write(content); win.document.close(); win.print();
        }

        function update(id, key, val, el) {
            const emp = employees.find(e => e.id == id); const v = val.trim().toUpperCase();
            emp.data = emp.data || {}; if(v === "") delete emp.data[key]; else emp.data[key] = v;
            const td = el.parentElement; td.className = td.className.replace(/cell-\S+/g, "").trim();
            const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : (v==='BÁ'?'cell-BA':v==='IG'?'cell-IG':v==='TU'?'cell-TU':v.startsWith('KÉ')?'cell-KE':'');
            if(cls) td.classList.add(cls);
            let s = 0; Object.values(emp.data).forEach(x => { let n=parseFloat(String(x).replace(',','.')); if(!isNaN(n)) s+=n; });
            document.getElementById(`rem-${id}`).innerText = (emp.yearlyQuota || 160) - s;
            save();
        }

        function jumpToToday() {
            const now = new Date(); date = new Date(2026, now.getMonth(), 1); render();
            setTimeout(() => { const el = document.getElementById('today-header'); if(el) document.querySelector('.table-container').scrollTo({ left: el.offsetLeft - 200, behavior: 'smooth' }); }, 100);
        }

        function initSortable() { Sortable.create(document.getElementById('tBody'), { animation: 150, handle: '.name-col', onEnd: function() { let n = []; document.querySelectorAll('#tBody tr').forEach(tr => { let e = employees.find(x => x.id == tr.getAttribute('data-id')); if(e) n.push(e); }); employees = n; save(); } }); }
        function highlight(el, dIdx, active) { el.closest('tr').classList.toggle('row-highlight', active); }
        async function backupAllData() { const shifts = ['A','B','C','D']; let f = {}; for(let s of shifts) { const r = await fetch(`${DB}shift_${s}.json`); f[s] = await r.json() || []; } const dl = document.createElement('a'); dl.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(f))); dl.setAttribute("download", `FORVIA_BACKUP.json`); dl.click(); }
        function changeMonth(v) { date.setMonth(date.getMonth() + v); render(); }
        function addEmp() { const n = prompt("Név:"); if(n) { employees.push({id:Date.now(), name:n, yearlyQuota:160, data:{}}); save(); render(); } }
        function delEmp(id) { if(confirm("Törlés?")) { employees = employees.filter(x => x.id != id); save(); render(); } }
        window.onload = () => changeShift(currentShift);
    </script>
</body>
</html>